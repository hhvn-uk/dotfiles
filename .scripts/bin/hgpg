#!/bin/sh

export LC_ALL=c

getpass="dpass gpg2key"

usage(){
	cat << .
hgpg	genkey
	export-key <key1> ...
	export-keyring
	list [<key1> ...]
	encrypt <recipient> [<file1> ...]
	import [<file1> ...]

<file> defaults to /dev/stdin
.
}

[ -z $1 ] && usage
a="$1"
shift

case "$a" in
	genkey) gpg --gen-key ;;
	export-key) 
		for k in $@
		do
			gpg --fingerprint $k
			printf "Destination? "
			read -r dest </dev/tty
			gpg --export --armour $k > $dest
		done
		;;
	export-keyring) gpg --export --armour ;;
	list*) 
		[ ! -z $1 ] && args="--keyid-format $1"
		gpg --list-keys $args && gpg --list-secret-keys $args
		;;
	encrypt)
		[ -z $1 ] && usage
		r="$1"
		shift
		for f in /dev/stdin $@
		do
			gpg --encrypt --sign --armour --passphrase "$($getpass)" -r "$r"
			echo
		done
		;;
	import)
		for k in /dev/stdin $@
		do
			gpg --import $k
			echo
		done
		;;
esac
