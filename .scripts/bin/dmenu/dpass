#!/bin/sh
#
# dmenu/dpass
# Created by Hayden Hamilton
#
# hayden@haydenvh.com
# Copyright (c) 2019-2020 Hayden Hamilton.
#

[ -z $PASS ] && PASS=$HOME/.local/pass
[ ! -f $PASS ] && touch $PASS
[ ! -z $1 ] && {
	passwd=$(grep "^$1: " < $PASS)
	shift
	[ -z $1 ] && echo "${passwd##*: }"|| echo "$@ ${passwd##*: }"
	exit
}
chosen=$(printf "GENERATE\nEDIT\n$(cut -d ':' -f 1 < $PASS)" | dmenu -l 20 -i | tr '[:upper:]' '[:lower:]')
passwd=$(grep "^$chosen: " < $PASS)

case "$chosen" in
	"") exit 1 ;;
	generate)
		new=$(head -c 2000 /dev/urandom | tr -dc 'a-zA-Z0-9~!@#$%^&*_+=-' | fold -w 35 | shuf | shuf | shuf | head -n 1)
		newname=$(echo | dmenu -i -p "Name for passwd?")
		[ "$newname" = "" ] && newname="pleaseeditthis"
		echo "$newname: $new" >> $PASS
		;;
	*)
		printf "${passwd##*: }\n" | xclip
		(
			sleep 5
			printf '' | xclip	# destroy clipboard to prevent accidental pasting
						# tbh, you should make a cronjob with this, run once per minute :)
		) &
		;;
esac
