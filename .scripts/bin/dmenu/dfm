#!/bin/bash
#
# dfm - Hayden's Dmenu File Manager
# Created by Hayden Hamilton
#
# haydenvh.com
# Copyright (c) 2019 Hayden Hamilton. LICENSE:GPLv2 ../../.licenses/gplv2.license
#

if [ "$(echo $1 | awk '/help/ {print}')" != "" ]
then
	echo "dfm [fm for standard mode/name of program for file-selection]

$(tput bold)CONFIG:$(tput sgr0)
DFM_DOT=\"[0 for no/1 for yes]\"
DFM_USE_HH_PATCH=\"[0 for no/1 to use the patched dmenu from haydenvh.com\"

Written by Hayden Hamilton <haydenvh.com>"
	exit 0
fi
forn1="$1"
if [ "$1" == "" ]
then
	export forn1="fm"
fi
dmenu="dmenu"
. $HOME/.dmenurc
. $HOME/.config/dfm/config
if [ "$DFM_USE_HH_PATCH" == "1" ]
then
	dmenu="$dmenu -c -w 1000"
fi

confdir="$HOME/.config/dfm"
conffile="$confdir/config"

makeconfdir(){
	if [ -d $confdir ]
	then
		echo > /dev/null
	else
		mkdir -p $confdir
	fi
}

sendconf(){
	varname="$1"
	varcont="$2"
	makeconfdir
	if [ -f $conffile ]
	then
		sed -i "/${varname}/d" $conffile
	fi
	echo "${varname}=\"${varcont}\"" >> $conffile
	. $conffile
}

fmornorm(){
	if [ "$forn1" == "fm" ]
	then
		output2=$(echo "$fmcmd2" | $dmenu -l 30 -i -p "Select command:")
		fmspecial
	else
		dooutput
		if [ "$doarg" == "true" ]
		then
			echo $forn1
			$forn1 $argu
		fi
	fi
}

dooutput(){
	enqueue=$(echo "DO ENQUEUE" | tr " " "\n" | $dmenu -i -p "What do you want to do?")
	if [ "$enqueue" == "ENQUEUE" ]
	then
		argu+="$(pwd)/$output "
		doarg="false"
	else
		argu+="$(pwd)/$output "
		doarg="true"
	fi
}

getdot(){
	. $conffile
	if [ "$DFM_DOT" == "1" ]
	then
		lscommand="ls -A"
	elif [ "$DFM_DOT" == "0" ]
	then
		lscommand="ls"
	else
		lscommand="ls -A"
	fi
}

fmspecial(){
	if [ "$output2" == "RM - Remove file" ]
	then
		rm $output
	elif [ "$output2" == "CMD - Specific command" ]
	then
		output3=$(dmenu_path | $dmenu -i -p "Select program")
		$output3 $output
	elif [ "$output2" == "MV - Move file" ]
	then
		output3=$(echo "" | $dmenu -i -p "Move to:")
		mv $output $output3
	elif [ "$output2" == "EDIT - Open with $EDITOR" ]
	then
		$EDITOR $output
	fi
}

cd $2
while true
do
	getdot
	output=$(echo "FM * .. $($lscommand)" | tr "\n" " " | tr " " "\n" |  $dmenu -l 30 -i -p "Select file/directory:")
	fmcmd1="CCL - CANCEL
MD - Make dir
MF - Make file
BM - Bookmarks
FND - Find
HIDE - Toggle Dotfiles"
	fmcmd2="CCL - CANCEL
MV - Move file
RM - Remove file
CMD - Specific command
EDIT - Open with $EDITOR"

	if [ "$output" == "FM" ]
	then
		output=$(echo "$fmcmd1" | $dmenu -l 30 -i -p "Select command:")
		if [ "$output" == "MD - Make dir" ]
		then
			output2=$(echo "" | $dmenu -i -p "Name dir:")
			mkdir $output2
		elif [ "$output" == "MF - Make file" ]
		then
			output2=$(echo "" | $dmenu -i -p "Name file:")
			touch $output2
		elif [ "$output" == "BM - Bookmarks" ]
		then
			mkdir ~/.config/dfm/
			touch ~/.config/dfm/bookmarks
			output=$(echo "MK DEL $(cat ~/.config/dfm/bookmarks | awk '// {print $1}')" | tr "\n" " " | tr " " "\n" |  $dmenu -l 30 -i -p "Select file/directory:")
			if [ "$output" == "MK" ]
			then
				output=$(echo "" | $dmenu -i -p "Choose bookmark name(no spaces):")
				output2=$(echo "" | $dmenu -i -p "Choose bookmark path(absolute):")
			 	echo "$output $output2" >> ~/.config/dfm/bookmarks
			elif [ "$output" == "DEL" ]
			then
				output=$(echo "$(cat ~/.config/dfm/bookmarks | awk '// {print $1}')" | $dmenu -l 30 -i -p "Select bookmark to delete:")
				delete=$(cat ~/.config/dfm/bookmarks | awk "/$output/")
				cat ~/.config/dfm/bookmarks | sed "/$delete/d" > ~/.config/dfm/bookmarks
			else
				output=$(cat ~/.config/dfm/bookmarks | awk "/$output/"' {print $2}')
				output2=$(echo "$fmcmd2" | $dmenu -l 30 -i -p "Select command:")
				fmspecial
			fi
		elif [ "$output" == "FND - Find" ]
		then
			output=$(echo "" | $dmenu -i -p "Enter name of file:")
			output=$(echo "NONE $(find . | grep -i "$output")" | tr " " "\n" | $dmenu -i -l 30 -p "Select file:")
			if [ "$output" == "NONE" ]
			then
				echo > /dev/null
			else
				fmornorm
			fi
		elif [ "$output" == "HIDE - Toggle Dotfiles" ]
		then
			if [ "$DFM_DOT" == "0" ]
			then
				export DFM_DOT="1"
				sendconf "DFM_DOT" "1"
			elif [ "$DFM_DOT" == "1" ]
			then
				export DFM_DOT="0"
				sendconf "DFM_DOT" "0"
			else
				export DFM_DOT="0"
				sendconf "DFM_DOT" "0"
			fi
		fi
	elif [ -d "$output" ]
	then
		cd $output
	elif [ "$output" == "exit" ]
	then
		exit 1
	elif [ "$output" == "" ]
	then
		exit 1
	else
		fmornorm
	fi
done
