#!/bin/sh

echo(){
	printf '%s\n' "$*"
}

matches(){
	echo "$arg" | grep -Ei "$@" >/dev/null
}

fmatches(){
	file "$arg" | grep -Ei "$@" >/dev/null
}

plumb(){
	t="$1"; shift
	[ $norun -eq 1 ] && return
	export norun=1
	case "$t" in
	gui)
		>/dev/null nohup sh -c "$*" "$arg" &
		;;
	terminal)
		>/dev/null nohup ${TERMINAL:-st} sh -c "$*" "$arg" &
		;;
	esac
}

rand(){
	base64 </dev/urandom | tr / + | head -c$1
}

_mktemp(){
	_mktemp_file="/tmp/$(rand 10)-$1"
	while [ -f $_mktemp_file ]
	do
		_mktemp_file="/tmp/$(rand 10)-$1"
	done
}

for arg in "$@"
do
	export norun=0
	export gui=0
	export proxy=""

	# network
	matches "://.*\.onion" &&
	export proxy="torsocks"

	matches "^magnet:" &&
	plumb terminal 'addtorrent $0'

	matches "^(gopher|http)s?://.*\.(mkv|mp4|avi|webm|ogg|ogv|gifv|mp3|mp4|opus|flac|ape|m3u|m3u8)$" ||
	matches "^https?://.*youtu.*be" &&
	plumb gui '$proxy mpv --pause $0'

	matches "^(gopher|http)s?://.*\.(jpe?g|gif|tiff?|ppm|bit|bmp|png|xpm)$" &&
	plumb gui '$proxy netimg $0'

	matches "^https?://" &&
	plumb gui 'xprop -id $(cat /tmp/tabbed.xid) >/dev/null && $proxy surf -e $(cat /tmp/tabbed.xid) $0 || >/tmp/tabbed.xid tabbed -c $proxy surf -e $(sleep 3 && cat /tmp/tabbed.xid) $0'

	matches "^gophers?://(.*/[17+](/|$)|[^/]*$)" &&
	plumb terminal '$proxy cgo $0'

	matches "^gophers?://" &&
	plumb terminal '$proxy curl $0 | vim -'

	matches "^mailto:" &&
	plumb terminal 'neomutt $(echo "$0" | sed "s~^mailto:~~")'

	matches "^finger://" &&
	plumb terminal '$proxy finger $(echo "$0" | sed "s~^finger://~~")'

	matches "^ssh://" &&
	plumb terminal '$proxy ssh $(echo "$0" | sed "s~^ssh://~~;s~:[0-9]*~~")'

	matches "^git://" &&
	plumb terminal '$proxy git clone $0'

	# local files now
	matches ".*\.(epub|ps|eps|pdf|dvi|djvu)$" ||
	fmatches "pdf|postscript" &&
	plumb gui 'zathura $0'

	matches ".*\.(mkv|mp4|avi|webm|ogg|ogv|gifv|mp3|mp4|opus|flac|ape|m3u|m3u8)$" ||
	fmatches "video|matroska|audio|sound" &&
	plumb terminal 'mpv --pause $0'

	matches ".*\.(jpe?g|gif|tiff?|ppm|bit|bmp|png|xpm)$" ||
	fmatches "image" &&
	plumb gui 'sxiv $0'

	matches ".*\.h$" &&
	[ -f "/usr/include/$arg" ] &&
	plumb terminal 'vim /usr/include/$0'

	matches ".*\.h$" &&
	[ -f "/usr/local/include/$arg" ] &&
	plumb terminal 'vim /usr/local/include/$0'

	matches "/.*\.[0-9]p?$" &&
	fmatches "(roff|preprocessor)" &&
	plumb terminal 'man $0'

	matches "[^/].*\.[0-9]p?$" &&
	fmatches "(roff|preprocessor)" &&
	plumb terminal 'man ./$0'

	matches ".*" &&
	plumb terminal 'vim $0'
done
wait
