#!/bin/sh

echo(){
	printf '%s\n' "$*"
}

matches(){
	echo "$arg" | grep -Ei "$@" >/dev/null
}

fmatches(){
	file "$arg" | grep -Ei "$@" >/dev/null
}

fmagic(){
	isfile "$arg" || return 1
	grep "$1" < "$arg" >/dev/null
}

_envsubst(){
	str="$*"

	env | 
	while read -r line
	do
		str=$(echo "$str" | awk -v "var=${line%%=*}" -v "val=${line#*=}" '
			{
				regex = sprintf("\\$%s", var)
				gsub(regex, val)
				print
			}'
		)
		echo "$str"
	done | tail -n 1
}

plumb(){
	t="$1"; shift
	[ $norun -eq 1 ] && return
	export norun=1
	case "$t" in
	gui)
		>/dev/null nohup sh -c "$*; rm '$file'" &
		;;
	terminal)
		>/dev/null nohup ${TERMINAL:-st} sh -c "$*; rm '$file'" &
		;;
	prompt)
		>/dev/null nohup ${TERMINAL:-st} sh -c "$(dmenu -i -p "$*"); rm '$file'" &
		;;
	*)
		herbe "No such plumb-type: $t"
		;;
	esac
}

replace(){
	arg=$(echo "$arg" | sed "$*")
}

isfile(){
	[ -z "$1" ] && {
		[ -f "$arg" ]
		return $?
	}
	[ -n "$1" ] && {
		[ -f "$1" ]
		return $?
	}
}

hascmd(){
	command -v "$*" >/dev/null
}

wasfetched(){
	[ -n "$orig" ]
}

fetch(){
	file="/tmp/plumb.$(basename "$arg")"
	while [ -f $file ]
	do
		file="/tmp/plumb.$(base64 </dev/urandom | tr -d / | head -c10).$(basename "$arg")"
	done
	$proxy curl "$(echo "$arg" | sed -E 's/]|\[|}|\{/\\&/g')" > "$file"
	export orig="$arg"
	export arg="$file"
}

for arg in "$@"
do
	export norun=0
	export gui=0
	export proxy=""
	export arg=$(_envsubst "$arg")
	export orig=""

	# remove file://
	matches "^file://" &&
	replace 's~^file://~~'

	# network
	matches "://.*\.onion" &&
	export proxy="torsocks"

	matches "^magnet:" &&
	plumb terminal 'addtorrent $arg'

	matches "^(gopher|http)s?://.*\.(mkv|mp4|avi|webm|ogg|ogv|gifv|mp3|mp4|opus|flac|ape|m3u|m3u8)$" ||
	matches "^https?://(www\.|m\.)?(youtube.com|youtu.be)" &&
	plumb gui '$proxy queuevid $arg; $proxy mpv --pause $arg'

	matches "^(gopher|http)s?://.*\.(jpe?g|gif|tiff?|ppm|bit|bmp|png|xpm)$" &&
	plumb gui '$proxy netimg $arg'

	matches "^(gopher|http)s?://.*\.(asc|gpg|pgp)$" &&
	fetch

	matches "^https?://" ||
	matches "\.html?$" ||
	fmatches "HTML" &&
	plumb gui 'xprop -id $(cat /tmp/tabbed.xid) >/dev/null && $proxy surf -e $(cat /tmp/tabbed.xid) $arg || { >/tmp/tabbed.xid tabbed -c & $proxy surf -e $(sleep 1 && cat /tmp/tabbed.xid) $arg; }'

	matches "^gophers?://(.*/[17+](/|$)|[^/]*$)" &&
	plumb terminal '$proxy cgo $arg'

	matches "^gophers?://" &&
	fetch

	matches "^mailto:" &&
	plumb terminal 'neomutt $(echo "$arg" | sed "s~^mailto:~~")'

	matches "^finger://" &&
	plumb terminal '$proxy finger $(echo "$arg" | sed "s~^finger://~~")'

	matches "^ssh://" &&
	plumb terminal '$proxy ssh $(echo "$arg" | sed "s~^ssh://~~;s~:[0-9]*~~")'

	matches "^git://" &&
	plumb terminal '$proxy git clone $arg'

	# local files now
	fmatches "PGP.*public.*key|PGP.*ring" &&
	isfile &&
	plumb terminal "gpg --import $arg; sleep 5"

	fmatches "PGP.*signature" &&
	isfile &&
	plumb terminal "gpg --verify $arg; sleep 5"

	fmatches "PGP.*message|PGP.*encrypted" &&
	isfile &&
	plumb terminal "gpg -d $arg; sleep 5"

	matches "\.(atom|rss)$|rss\.xml$" ||
	fmatches "atom|rss" ||
	fmagic "<feed.*xmlns.*http://www.w3.org/2005/Atom" ||
	fmagic "^<rss" &&
	wasfetched &&
	plumb terminal 'sfeed_addfeed $orig'

	matches ".*\.(epub|ps|eps|pdf|dvi|djvu)$" ||
	fmatches "pdf|postscript" &&
	isfile &&
	plumb gui 'zathura $arg'

	matches ".*\.(mkv|mp4|avi|webm|ogg|ogv|gifv|mp3|mp4|opus|flac|ape|m3u|m3u8)$" ||
	fmatches "video|matroska|audio|sound" &&
	isfile &&
	plumb terminal 'mpv --pause $arg'

	matches ".*\.(jpe?g|gif|tiff?|ppm|bit|bmp|png|xpm)$" ||
	fmatches "image" &&
	isfile &&
	plumb gui 'sxiv $arg'

	matches "\.?/.*\.[0-9]p?$" &&
	fmatches "(roff|preprocessor)" &&
	isfile &&
	plumb terminal 'man $arg'

	matches "\.(gph|gophermap)$|(^|/)gophermap$" &&
	isfile &&
	plumb terminal 'cgo -f $arg'

	# numbered file
	matches ":[0-9][0-9]*$" &&
	isfile ${arg%:*} &&
	plumb terminal 'vim +${arg##*:} ${arg%:*}'

	# catch all for files
	matches ".*" &&
	isfile &&
	plumb terminal 'vim $arg'

	# include files
	matches ".*\.h$" &&
	isfile "/usr/include/$arg" &&
	plumb terminal 'vim /usr/include/$arg'

	matches ".*\.h$" &&
	isfile "/usr/local/include/$arg" &&
	plumb terminal 'vim /usr/local/include/$arg'

	# catch-all for non-files
	matches ".*" &&
	plumb prompt 'Plumb to (use $arg): '
done
wait
