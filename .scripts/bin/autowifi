#!/bin/sh
#
# autowifi.sh
# Created by Hayden Hamilton
#
# hayden@haydenvh.com
# Copyright (c) 2020 Hayden Hamilton
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.
#
# This work is free. You can redistribute it and/or modify it under the      
# terms of the Do What The Fuck You Want To Public License, Version 2,       
# as published by Sam Hocevar. See http://www.wtfpl.net/ for more details.   
#
# depends: inetutils-ifconfig, wireless_tools, wpa_supplicant, dhclient

[ $(id | sed -E 's~uid=([0-9]*).*~\1~') -eq 0 ] && super="" || {
	command -v doas >/dev/null && super=doas || super=sudo
}

# guess the wireless interface
[ -z $1 ] && {
	interface=$(ip a | grep -o '^[0-9]*: w[^:]*:' | sed -E 's/[0-9]*: ([^:]*):/\1/' | head -n 1)
	echo "$interface" | grep '[[:alnum:]]' >/dev/null || {
		echo "Couldn't guess the interface, please provide one as argument 1"
		exit 1
	}
} || interface="$1"

$super ifconfig $interface up

ssid=$($super iwlist $interface scan 2>&1 | grep SSID | sed -E 's/.*:"([^"]*)"/\1/' | dmenu -i)
pass=$(printf '' | dmenu -i -p "Passphrase:")

wpa_passphrase "$ssid" "$pass" > /tmp/"$ssid".wpa.conf
$super wpa_supplicant -B -i $interface -c /tmp/"$ssid".wpa.conf
$super dhclient

sleep 2
tput setaf 10
echo "...testing..."
sleep 7
tput sgr0
ping -I $interface -c 5 example.com 2>&1 | tee /dev/stderr | grep '5 received,' >/dev/null && {
	tput setaf 10
	echo "Yup"
} || {
	tput setaf 10
	echo "Something broke.. :("
}
