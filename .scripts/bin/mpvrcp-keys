#!/bin/sh

trap 'drawgui'     28 #SIGWINCH
trap 'stty icanon' 2  #SIGINT

clear

send(){
	echo "{ \"command\": [$1] }" | socat - $2 >/dev/null || {
		tput cup 0 0 && tput el
		printf '%s' "can't connect to socket..."
		sleep 0.5
		drawgui
	}
}

toggle(){
	paused=$(echo '{ "command": ["get_property", "pause"] }' | socat - $1 2>/dev/null | tr '{":0,}' ' ' | awk '// {print $2}')
	[ "$paused" = "true" ] && {
		echo '{ "command": ["set_property", "pause", false] }' | socat - $1 > /dev/null
	} || {
		echo '{ "command": ["set_property", "pause", true] }' | socat - $1 > /dev/null
	}
}

drawgui(){
	tput cup 0 0
	tput el
	printf 'quit(q) rand(m) pause(p) vol(+-) prev(h) back(j) forward(k) next(l)'
}

stty -icanon
getchar(){
	drawgui
	key=$(dd if=/dev/stdin bs=1 count=1 2>/dev/null)
}

while getchar
do
	[ "$key" = "h" ] && send '"playlist-prev"' /tmp/mpv-socket
	[ "$key" = "j" ] && send '"seek", "-10"' /tmp/mpv-socket
	[ "$key" = "k" ] && send '"seek", "10"' /tmp/mpv-socket
	[ "$key" = "l" ] && send '"playlist-next"' /tmp/mpv-socket
	[ "$key" = "q" ] && send '"quit"' /tmp/mpv-socket
	[ "$key" = "p" ] && toggle /tmp/mpv-socket
	[ "$key" = "+" ] && amixer set Master 5%+ >/dev/null 2>/dev/null
	[ "$key" = "-" ] && amixer set Master 5%- >/dev/null 2>/dev/null
	[ "$key" = "m" ] && rmpv music/list 150 >/dev/null 2>/dev/null & # rmpv is another script of mine
done
