#!/bin/sh
#
# uptimemon.sh - monitor and record uptime (records)
#
# hayden@haydenvh.com
# Copyright (c) 2020 Hayden Hamilton
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.
#
# This work is free. You can redistribute it and/or modify it under the
# terms of the Do What The Fuck You Want To Public License, Version 2,
# as published by Sam Hocevar. See http://www.wtfpl.net/ for more details.

d=$HOME/net/exec/uptime

for s in local irc1 irc2 dumbterm.haydenvh.com phony.haydenvh.com port.haydenvh.com
do 
	curr=$(ssh $s uptime | awk '{print $3}' | grep '^[^:]*$' || echo 0)
	[ ! -f $d/$s ] && echo "curr	$curr" > $d/$s
	[ -f $d/$s ] && {
		awk -F"	" -v "curr=$curr" '
			$1 == "curr" {
				if ($2 > curr) {
					print "curr	" curr
					print "record	" $2
				} else {
					print "curr	" curr
				}
			}
			$1 == "record"' < $d/$s > $d/$s.new 
		mv $d/$s.new $d/$s
	}
done
